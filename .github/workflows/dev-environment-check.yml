name: Development Setup Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-dev-environment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js for VS Code CLI
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install VS Code CLI
      run: |
        curl -Lk 'https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-x64' --output vscode_cli.tar.gz
        tar -xf vscode_cli.tar.gz
        sudo mv code /usr/local/bin/
        
    - name: Check required extensions
      run: |
        echo "ğŸ” Gerekli VS Code extension'larÄ± kontrol ediliyor..."
        
        # Gerekli extension'lar (gÃ¼ncel extensions.json ile uyumlu)
        REQUIRED_EXTENSIONS=(
          "ms-python.python"
          "matangover.mypy"
          "ms-python.mypy-type-checker"
          "charliermarsh.ruff"
        )
        
        MISSING_EXTENSIONS=()
        
        # Extensions.json dosyasÄ±ndan Ã¶nerilen extension'larÄ± oku
        if [ -f ".vscode/extensions.json" ]; then
          echo "âœ… .vscode/extensions.json dosyasÄ± bulundu"
          
          # JSON'u parse etmek iÃ§in temel Unix araÃ§larÄ± kullan
          # AWK ile parse et (en taÅŸÄ±nabilir)
          if command -v awk >/dev/null 2>&1; then
            RECOMMENDED_EXTS=$(awk -F'"' '/"[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+"/ {
              for(i=1;i<=NF;i++) {
                if($i ~ /^[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+$/) {
                  print $i
                }
              }
            }' .vscode/extensions.json)
          else
            # Fallback: grep + sed (her yerde mevcut)
            RECOMMENDED_EXTS=$(grep -o '"[^"]*\.[^"]*"' .vscode/extensions.json | sed 's/"//g')
          fi
          
          # Her gerekli extension'Ä±n recommendations'da olup olmadÄ±ÄŸÄ±nÄ± kontrol et
          for ext in "${REQUIRED_EXTENSIONS[@]}"; do
            if echo "$RECOMMENDED_EXTS" | grep -q "^$ext$"; then
              echo "âœ… $ext - extensions.json'da mevcut"
            else
              MISSING_EXTENSIONS+=("$ext")
              echo "âŒ $ext - extensions.json'da bulunamadÄ±"
            fi
          done
        else
          echo "âŒ .vscode/extensions.json dosyasÄ± bulunamadÄ±!"
          exit 1
        fi
        
        # SonuÃ§larÄ± deÄŸerlendir
        if [ ${#MISSING_EXTENSIONS[@]} -eq 0 ]; then
          echo ""
          echo "ğŸ‰ TÃ¼m gerekli extension'lar .vscode/extensions.json'da tanÄ±mlÄ±!"
          echo ""
          echo "ğŸ“‹ Kontrol edilen extension'lar:"
          for ext in "${REQUIRED_EXTENSIONS[@]}"; do
            echo "  âœ… $ext"
          done
        else
          echo ""
          echo "ğŸš¨ Eksik extension'lar tespit edildi!"
          echo ""
          echo "âŒ Eksik extension'lar:"
          for ext in "${MISSING_EXTENSIONS[@]}"; do
            echo "  - $ext"
          done
          echo ""
          echo "ğŸ”§ Ã‡Ã¶zÃ¼m: .vscode/extensions.json dosyasÄ±na ÅŸu extension'larÄ± ekleyin:"
          for ext in "${MISSING_EXTENSIONS[@]}"; do
            echo "  \"$ext\""
          done
          exit 1
        fi
        
    - name: Validate extensions.json format
      run: |
        echo "ğŸ”§ extensions.json formatÄ± kontrol ediliyor..."
        
        if ! python3 -c "import json; json.load(open('.vscode/extensions.json'))" 2>/dev/null; then
          echo "âŒ .vscode/extensions.json geÃ§erli bir JSON formatÄ±nda deÄŸil!"
          exit 1
        else
          echo "âœ… extensions.json formatÄ± geÃ§erli"
        fi
        
    - name: Check extension installation script
      run: |
        echo "ğŸ”§ Extension kurulum script'i kontrol ediliyor..."
        
        if [ -f "install-extensions.sh" ]; then
          echo "âœ… install-extensions.sh script'i mevcut"
          
          # Script'in executable olup olmadÄ±ÄŸÄ±nÄ± kontrol et
          if [ -x "install-extensions.sh" ]; then
            echo "âœ… install-extensions.sh executable permission'a sahip"
          else
            echo "âš ï¸  install-extensions.sh executable deÄŸil (chmod +x gerekli)"
          fi
          
          # Script'in temel syntax'Ä±nÄ± kontrol et
          if bash -n install-extensions.sh; then
            echo "âœ… install-extensions.sh syntax kontrolÃ¼ baÅŸarÄ±lÄ±"
          else
            echo "âŒ install-extensions.sh syntax hatasÄ± var!"
            exit 1
          fi
        else
          echo "âŒ install-extensions.sh script'i bulunamadÄ±!"
          echo "ğŸ’¡ Bu script VS Code task'larÄ±nda otomatik extension kurulumu iÃ§in gerekli"
          exit 1
        fi
        
    - name: Summary
      if: success()
      run: |
        echo ""
        echo "ğŸ¯ Development Environment Check - BAÅARILI"
        echo "âœ… Python extension tanÄ±mlÄ±"
        echo "âœ… MyPy type checker extensions tanÄ±mlÄ±"
        echo "âœ… Ruff linter extension tanÄ±mlÄ±"
        echo "âœ… extensions.json formatÄ± geÃ§erli"
        echo ""
        echo "ğŸ’¡ GeliÅŸtirici notu:"
        echo "   VS Code aÃ§Ä±ldÄ±ÄŸÄ±nda bu extension'larÄ± yÃ¼klemeniz Ã¶nerilecektir."
        echo "   Otomatik kurulum: ./install-extensions.sh script'i kullanÄ±lÄ±r."
